const hostSelect=document.getElementById("hostSelect"),treeEl=document.getElementById("tree"),emptyEl=document.getElementById("empty"),refreshBtn=document.getElementById("refreshBtn"),lastUpdated=document.getElementById("lastUpdated"),searchBox=document.getElementById("searchBox");
async function j(u){const r=await fetch(u);if(!r.ok)throw new Error("HTTP "+r.status);return r.json()}
async function loadHosts(){const d=await j("/api/hosts/");hostSelect.innerHTML="";(d.hosts||[]).forEach(h=>{const o=document.createElement("option");o.value=h;o.textContent=h;hostSelect.appendChild(o)})}
function fmt(n){return n==null||isNaN(n)?"-":Number(n).toFixed(1)}
function nodeView(p){const r=document.createElement("div");r.className="node";const hasKids=p.children&&p.children.length,c=document.createElement("span");c.textContent=hasKids?"▾":"";const n=document.createElement("span");n.textContent=`${p.name} (${p.pid})`;const m=document.createElement("span");m.textContent=`CPU ${fmt(p.cpu)}% · MEM ${fmt(p.mem_mb)}MB`;r.appendChild(c);r.appendChild(n);r.appendChild(m);if(hasKids){const w=document.createElement("div");w.className="children";p.children.forEach(ch=>w.appendChild(nodeView(ch)));r.appendChild(w);c.onclick=()=>{w.style.display=w.style.display==="none"?"":"none";c.textContent=w.style.display==="none"?"▸":"▾"}};r.dataset.name=(p.name||"").toLowerCase();return r}
async function loadLatest(){const h=hostSelect.value||"",d=await j(`/api/processes/latest/?hostname=${encodeURIComponent(h)}`);treeEl.innerHTML="";if(!d.tree||!d.tree.length){emptyEl.classList.remove("hidden")}else{emptyEl.classList.add("hidden");d.tree.forEach(p=>treeEl.appendChild(nodeView(p)))};lastUpdated.textContent=d.timestamp?`Last Updated: ${new Date(d.timestamp).toLocaleString()}`:""}
function applySearch(){const q=searchBox.value.trim().toLowerCase();document.querySelectorAll(".node").forEach(n=>n.classList.remove("highlight"));if(!q)return;document.querySelectorAll(".node").forEach(n=>{if((n.dataset.name||"").includes(q))n.classList.add("highlight")})}
refreshBtn.onclick=loadLatest;hostSelect.onchange=loadLatest;searchBox.oninput=applySearch;(async()=>{await loadHosts();await loadLatest();setInterval(loadLatest,5000)})();
